å¥½çš„ âœ…
ä»¥ä¸‹ä¸ºå¯ç›´æ¥äº¤ä»˜ç»™ Cursor / O1 çš„è§„èŒƒæ–‡ä»¶ï¼š

---

# ğŸ“ ã€ŠDatapull GUI å‚æ•°ä¸æ¥å£è§„èŒƒ v1.1ã€‹

**ç‰ˆæœ¬**ï¼šv1.1
**å‘å¸ƒæ—¥æœŸ**ï¼š2025-11-07
**é€‚ç”¨èŒƒå›´**ï¼šDatapull å‰ç«¯ GUI + æœ¬åœ° API æœåŠ¡ï¼ˆåç«¯ï¼‰
**é…å¥—æ–‡æ¡£**ï¼šã€ŠDatapull GUI ç ”å‘æ–‡æ¡£ v1.1ã€‹ã€ŠDriveQuiz API v1.1 ä¸‰ä»¶å¥—ï¼ˆäº§å“/ç ”å‘/å‚æ•°ï¼‰ã€‹

---

## 0. ç›®æ ‡ä¸è¾¹ç•Œ

* æœ¬è§„èŒƒç”¨äº**å‰ç«¯ GUI â†” Datapull æœ¬åœ° API**çš„å‚æ•°ä¸æ¥å£ç»Ÿä¸€ï¼›
* GUI åªè´Ÿè´£**é…ç½®/ä»»åŠ¡/æ—¥å¿—/ä¸Šä¼ **çš„å¯è§†åŒ–ï¼Œä¸æ”¹å˜ Datapull æ ¸å¿ƒçˆ¬å–ä¸åˆ†ç‰‡é€»è¾‘ï¼›
* ä¸Šä¼ åˆ° DriveQuiz ä»…é€šè¿‡ Datapull åç«¯è½¬å‘ï¼ŒGUI ä¸ç›´æ¥è°ƒç”¨ DriveQuizã€‚

---

## 1. ç›®å½•ä¸æ–‡ä»¶

```
apps/datapull/
 â”œâ”€ src/core/                      # å·²æœ‰ï¼šæŠ“å–ã€æŠ½å–ã€åˆ†ç‰‡ã€å…¥åº“
 â”œâ”€ src/api/                       # åç«¯ï¼šFastifyï¼ˆæ–°å¢/å¯¹é½ï¼‰
 â”‚   â”œâ”€ index.ts                   # æœåŠ¡å¯åŠ¨ä¸è·¯ç”±èšåˆ
 â”‚   â””â”€ routes/
 â”‚       â”œâ”€ sources.ts             # GET/POST/PUT/DELETE /api/sources*
 â”‚       â”œâ”€ tasks.ts               # POST /api/tasks/*, GET /api/tasks/status
 â”‚       â”œâ”€ logs.ts                # GET /api/logs
 â”‚       â”œâ”€ upload.ts              # POST /api/upload/batch
 â”‚       â””â”€ system.ts              # GET /api/system/status
 â””â”€ src/gui/                       # å‰ç«¯ï¼šVue3 + Vite + Pinia
     â”œâ”€ pages/                     # Pagesï¼ˆSources / Tasks / Upload / Logs / Systemï¼‰
     â”œâ”€ components/                # DataTable / LogViewer / StatCard ...
     â”œâ”€ services/datapullApi.ts    # axios å°è£…ï¼ˆç»Ÿä¸€æ‹¦æˆªå™¨ï¼‰
     â”œâ”€ store/guiStore.ts          # Pinia å…¨å±€çŠ¶æ€
     â””â”€ router.ts                  # è·¯ç”±å£°æ˜
```

---

## 2. æšä¸¾ä¸é€šç”¨ç±»å‹

```ts
// src/gui/types/common.ts
export type ISODate = string;

export type TaskStatus = "idle" | "running" | "stopped" | "error";
export type ChunkStatus = "pending" | "uploaded" | "failed";
export type LogType = "system" | "crawl" | "upload";
export type LangCode = "ja" | "zh" | "en";

export interface ApiRespOk<T> { success: true; data: T; }
export interface ApiRespErr { success: false; error: { code: string; message: string; details?: any; } }
export type ApiResp<T> = ApiRespOk<T> | ApiRespErr;
```

---

## 3. æ•°æ®æ¨¡å‹ï¼ˆå‰åç«¯ä¸€è‡´ï¼‰

### 3.1 Sourceï¼ˆæ•°æ®æºï¼‰

```ts
export interface Source {
  id: string;                  // å”¯ä¸€ï¼šå¦‚ "gov_npa_driving"
  name: string;                // å±•ç¤ºå
  seedUrls: string[];          // èµ·å§‹URL
  include: string[];           // URLåŒ…å«è§„åˆ™ï¼ˆglob/regexï¼‰
  exclude: string[];           // URLæ’é™¤è§„åˆ™
  lang: LangCode;              // è¯­è¨€
  version: string;             // ç‰ˆæœ¬ï¼Œå¦‚ "2025Q1"
  enabled: boolean;            // æ˜¯å¦çº³å…¥ä»»åŠ¡
  crawlDepth?: number;         // çˆ¬å–æ·±åº¦ï¼ˆé»˜è®¤2ï¼‰
  rateLimitQPS?: number;       // æŠ“å–é€Ÿç‡é™åˆ¶
  notes?: string;              // å¤‡æ³¨
  updatedAt: ISODate;
  createdAt: ISODate;
}
```

### 3.2 Taskï¼ˆä»»åŠ¡çŠ¶æ€ï¼‰

```ts
export interface TaskStatusDTO {
  status: TaskStatus;          // idle|running|stopped|error
  runningSources: string[];    // å½“å‰æ‰§è¡Œçš„ source.id åˆ—è¡¨
  startedAt?: ISODate;
  lastHeartbeat?: ISODate;
  progress?: {                  // æŒ‰ source æ±‡æ€»
    [sourceId: string]: {
      pagesVisited: number;
      chunksGenerated: number;
      uploaded: number;
      failed: number;
    };
  };
}
```

### 3.3 Chunkï¼ˆåˆ†ç‰‡è®°å½•ï¼‰

```ts
export interface ChunkDTO {
  id: string;                  // æœ¬åœ°å”¯ä¸€ID
  sourceId: string;
  title: string;
  url: string;
  content: string;
  version: string;
  lang: LangCode;
  meta: {
    chunkIndex: number;
    totalChunks: number;
    contentHash: string;       // sha256
  };
  status: ChunkStatus;         // pending|uploaded|failed
  errorMessage?: string;
  createdAt: ISODate;
  updatedAt: ISODate;
}
```

### 3.4 Systemï¼ˆç³»ç»ŸçŠ¶æ€ï¼‰

```ts
export interface SystemStatusDTO {
  version: string;             // Datapull ç‰ˆæœ¬
  appUptimeSec: number;
  cpuUsage: number;            // %
  memUsage: number;            // %
  diskFreeGB: number;
  queueSize: number;           // å¾…å¤„ç†/å¾…ä¸Šä¼  é˜Ÿåˆ—é•¿åº¦
  driveQuizReachable: boolean; // è¿é€šæ€§æ¢æµ‹
  lastUploadAt?: ISODate;
}
```

---

## 4. åç«¯ APIï¼ˆRESTï¼‰

**Base URL**ï¼š`/api`

### 4.1 Sourcesï¼ˆæ•°æ®æºç®¡ç†ï¼‰

#### GET `/api/sources`

* **æŸ¥è¯¢å‚æ•°**ï¼š`q?=keyword`ï¼ˆå¯é€‰ï¼ŒæŒ‰ id/name æ¨¡ç³Šï¼‰
* **å“åº”**ï¼š`ApiResp<Source[]>`

#### POST `/api/sources`

* **è¯·æ±‚ä½“**ï¼š`Source`ï¼ˆåˆ›å»ºæ—¶ `id` å”¯ä¸€ã€`createdAt/updatedAt` åç«¯å¡«å……ï¼‰
* **æ ¡éªŒ**ï¼š

  * `id`ï¼š`^[a-z0-9_]{3,50}$`
  * `seedUrls`ï¼šéç©º http(s)
* **å“åº”**ï¼š`ApiResp<Source>`

#### PUT `/api/sources/:id`

* **è¯·æ±‚ä½“**ï¼š`Partial<Source>`ï¼ˆä¸å¯å˜æ›´ idï¼‰
* **å“åº”**ï¼š`ApiResp<Source>`

#### DELETE `/api/sources/:id`

* **å“åº”**ï¼š`ApiResp<{ deleted: boolean }>`

### 4.2 Tasksï¼ˆä»»åŠ¡æ§åˆ¶ï¼‰

#### POST `/api/tasks/start`

* **è¯·æ±‚ä½“**ï¼š

```ts
{ sourceIds?: string[]; mode?: "full" | "incremental"; }
```

* `sourceIds` ä¸ºç©ºåˆ™å¯¹æ‰€æœ‰ `enabled=true` çš„æºæ‰§è¡Œ
* **å“åº”**ï¼š`ApiResp<{ started: boolean; startedAt: ISODate }>`

#### POST `/api/tasks/stop`

* **å“åº”**ï¼š`ApiResp<{ stopped: boolean; stoppedAt: ISODate }>`

#### GET `/api/tasks/status`

* **å“åº”**ï¼š`ApiResp<TaskStatusDTO>`

### 4.3 Logsï¼ˆæ—¥å¿—ï¼‰

#### GET `/api/logs`

* **æŸ¥è¯¢å‚æ•°**ï¼š

  * `type?=system|crawl|upload`ï¼ˆé»˜è®¤å…¨éƒ¨ï¼‰
  * `sourceId?=...`
  * `level?=info|warn|error`
  * `limit?=100`ï¼ˆæœ€å¤§ 1000ï¼‰
* **å“åº”**ï¼š

```ts
ApiResp<{
  items: Array<{ ts: ISODate; type: LogType; level: string; message: string; sourceId?: string; }>
  nextCursor?: string; // é¢„ç•™
}>
```

### 4.4 Uploadï¼ˆä¸Šä¼ ä¸­å¿ƒï¼‰

#### GET `/api/chunks`

* **æŸ¥è¯¢å‚æ•°**ï¼š

  * `status?=pending|uploaded|failed`ï¼ˆé»˜è®¤ pendingï¼‰
  * `sourceId?=...`
  * `page?=1` `pageSize?=50`ï¼ˆmax 200ï¼‰
* **å“åº”**ï¼š

```ts
ApiResp<{ items: ChunkDTO[]; page: number; pageSize: number; total: number; }>
```

#### POST `/api/upload/batch`

* **ç”¨é€”**ï¼šå°†é€‰ä¸­çš„åˆ†ç‰‡æ‰¹é‡ä¸Šä¼ è‡³ **DriveQuiz**ï¼ˆé€šè¿‡ Datapull åç«¯è½¬å‘ï¼‰
* **è¯·æ±‚ä½“**ï¼š

```ts
{
  chunkIds: string[];          // æœ¬åœ°åˆ†ç‰‡IDåˆ—è¡¨
  mode?: "auto" | "manual";    // é»˜è®¤ "manual"
}
```

* **å“åº”**ï¼ˆè½¬å‘ DriveQuiz çš„æ‰¹é‡å“åº” + æœ¬åœ°æ˜ å°„ï¼‰ï¼š

```ts
ApiResp<{
  operationId: string;         // DriveQuiz opId
  processed: number;
  failed: number;
  results: Array<{
    chunkId: string;
    status: "success" | "failed" | "duplicate";
    error?: { code: string; message: string; };
  }>;
}>
```

### 4.5 Systemï¼ˆç³»ç»ŸçŠ¶æ€ï¼‰

#### GET `/api/system/status`

* **å“åº”**ï¼š`ApiResp<SystemStatusDTO>`

---

## 5. WebSocketï¼ˆå®æ—¶æ¨é€ï¼‰

**è·¯å¾„**ï¼š`/ws`
**åè®®**ï¼šJSON è¡Œæ¶ˆæ¯ï¼ˆæ¯æ¡ä¸€è¡Œï¼‰

### 5.1 äº‹ä»¶æ ¼å¼

```ts
type WsEvent =
  | { event: "task.status"; payload: TaskStatusDTO }
  | { event: "log.append"; payload: { ts: ISODate; type: LogType; level: string; message: string; sourceId?: string; } }
  | { event: "chunk.update"; payload: { chunkId: string; status: ChunkStatus; errorMessage?: string } }
  | { event: "upload.completed"; payload: { operationId: string; processed: number; failed: number } };
```

### 5.2 è®¢é˜…ç­–ç•¥

* è¿æ¥å³å…¨é‡è®¢é˜…ï¼›å‰ç«¯è‡ªè¡Œç­›é€‰å±•ç¤ºï¼›
* å¿ƒè·³ï¼šæœåŠ¡å™¨æ¯ 30s å‘é€ `{"event":"heartbeat","payload":{}}`ã€‚

---

## 6. GUI å‰ç«¯ API å°è£…ï¼ˆçº¦å®šï¼‰

**ç»Ÿä¸€å“åº”å¤„ç†**ï¼š

* æˆåŠŸï¼š`resp.data.success === true`
* å¤±è´¥ï¼šæŠ›å‡º `{ code, message, details }`

```ts
// src/gui/services/datapullApi.ts
import axios from "axios";
const api = axios.create({ baseURL: "/api", timeout: 15000 });

api.interceptors.response.use(
  (r) => r.data.success ? r.data : Promise.reject(r.data.error),
  (e) => Promise.reject({ code: "NETWORK_ERROR", message: e.message })
);

export const getSources = () => api.get("/sources");
export const createSource = (payload) => api.post("/sources", payload);
export const updateSource = (id, patch) => api.put(`/sources/${id}`, patch);
export const deleteSource = (id) => api.delete(`/sources/${id}`);

export const startTasks = (payload) => api.post("/tasks/start", payload);
export const stopTasks = () => api.post("/tasks/stop");
export const getTaskStatus = () => api.get("/tasks/status");

export const getLogs = (params) => api.get("/logs", { params });

export const listChunks = (params) => api.get("/chunks", { params });
export const uploadBatch = (payload) => api.post("/upload/batch", payload);

export const getSystemStatus = () => api.get("/system/status");
```

---

## 7. é”™è¯¯ç 

| code             | HTTP | å«ä¹‰                   | è§£å†³å»ºè®®             |
| ---------------- | ---- | -------------------- | ---------------- |
| UNAUTHORIZED     | 401  | æœªé…ç½®æˆ–æ— æ•ˆçš„ GUI è®¿é—®ä»¤ç‰Œï¼ˆå¦‚éœ€ï¼‰ | æ£€æŸ¥ç™»å½•/ä»¤ç‰Œ          |
| INVALID_REQUEST  | 400  | å‚æ•°éæ³•                 | æ£€æŸ¥è¡¨å•æˆ–è°ƒç”¨å‚æ•°        |
| SOURCE_DUPLICATE | 409  | Source.id å·²å­˜åœ¨        | æ›´æ¢ id            |
| TASK_CONFLICT    | 409  | ä»»åŠ¡è¿è¡Œä¸­ï¼Œæ— æ³•é‡å¤å¯åŠ¨         | ç­‰å¾…æˆ–å…ˆåœæ­¢           |
| NOT_FOUND        | 404  | èµ„æºä¸å­˜åœ¨                | æ£€æŸ¥ id            |
| UPLOAD_FAILED    | 502  | è½¬å‘è‡³ DriveQuiz å¤±è´¥     | æ£€æŸ¥ DriveQuiz API |
| RATE_LIMITED     | 429  | é¢‘æ§                   | é™ä½é¢‘ç‡             |
| INTERNAL_ERROR   | 500  | æœªçŸ¥é”™è¯¯                 | æŸ¥çœ‹æ—¥å¿—             |

---

## 8. æ ¡éªŒè§„åˆ™ï¼ˆå‰ç«¯+åç«¯ä¸€è‡´ï¼‰

* `Source.id`ï¼š`^[a-z0-9_]{3,50}$`
* `seedUrls`ï¼šæ¯é¡¹å¿…é¡» `http(s)://` å¼€å¤´
* `include/exclude`ï¼šå¯ä¸º globï¼ˆ`**/*.pdf`ï¼‰æˆ–æ­£åˆ™å­—ç¬¦ä¸²ï¼ˆä»¥ `/.../` åŒ…è£¹ï¼‰
* `version`ï¼š`^\d{4}(Q[1-4])?$`ï¼ˆå¦‚ `2025Q1` æˆ– `2025`ï¼‰
* `lang`ï¼š`ja|zh|en`
* `crawlDepth`ï¼š1â€“5ï¼ˆé»˜è®¤2ï¼‰
* `rateLimitQPS`ï¼š1â€“50ï¼ˆé»˜è®¤5ï¼‰

---

## 9. ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# æœåŠ¡ç«¯
DATAPULL_PORT=3100
DATAPULL_DATA_PATH=./data
DATAPULL_SOURCES_FILE=./config/sources.json

# DriveQuiz è½¬å‘
DRIVEQUIZ_API_URL=https://drivequiz.example.com/api/v1/rag
DRIVEQUIZ_API_TOKEN=xxx

# å‰ç«¯
GUI_AUTH_ENABLED=false
GUI_BASIC_USER=admin
GUI_BASIC_PASS=admin123
```

> è‹¥ `GUI_AUTH_ENABLED=true`ï¼Œåç«¯ç»™ `/api/*` å¢åŠ  Basic Auth ä¸­é—´ä»¶ï¼›å‰ç«¯åœ¨é¦–æ¬¡è®¿é—®æ—¶å¼¹çª—ç™»å½•ã€‚

---

## 10. äº¤äº’å¥‘çº¦ï¼ˆå…³é”®æµç¨‹ï¼‰

### 10.1 è¿è¡Œå…¨é‡ä»»åŠ¡ï¼ˆGUIï¼‰

1. `GET /api/sources` â†’ é€‰æ‹©å‹¾é€‰ `enabled=true` çš„æº
2. `POST /api/tasks/start`ï¼ˆä¸ä¼  `sourceIds`ï¼‰
3. è®¢é˜… `/ws`ï¼š`task.status` / `log.append` å®æ—¶æ¸²æŸ“
4. ä»»åŠ¡ç»“æŸ â†’ `GET /api/chunks?status=pending`
5. `POST /api/upload/batch`ï¼ˆé€‰æ‹©æ€§æ‰¹é‡ä¸Šä¼ ï¼‰
6. `upload.completed` äº‹ä»¶ â†’ æˆåŠŸæ•°ä¸å¤±è´¥æ•°è½åœ°

### 10.2 ä¿®æ­£å¤±è´¥åˆ†ç‰‡å¹¶é‡è¯•

1. `GET /api/chunks?status=failed&sourceId=...`
2. å‹¾é€‰ â†’ `POST /api/upload/batch`
3. æŸ¥çœ‹ç»“æœ â†’ è‹¥ä»å¤±è´¥ï¼Œç‚¹å‡»è¡Œå†…â€œæŸ¥çœ‹é”™è¯¯è¯¦æƒ…â€ï¼ˆæ˜¾ç¤º `errorMessage`ï¼‰

---

## 11. ç»„ä»¶å‚æ•°ï¼ˆæ ¸å¿ƒç»„ä»¶ï¼‰

### 11.1 `<DataTable />`

```ts
props: {
  columns: Array<{ key: string; label: string; width?: number; formatter?: (v:any,row:any)=>string }>,
  rows: any[],
  pagination?: { page: number; pageSize: number; total: number; onChange: (p)=>void },
  selectable?: boolean,
  onRowSelect?: (ids: string[]) => void
}
```

### 11.2 `<LogViewer />`

```ts
props: {
  logs: Array<{ ts: ISODate; type: LogType; level: string; message: string; sourceId?: string; }>,
  autoScroll?: boolean
}
```

### 11.3 `<StatCard />`

```ts
props: { label: string; value: string | number; hint?: string; loading?: boolean }
```

---

## 12. å®‰å…¨ä¸æ€§èƒ½

* **é€Ÿç‡é™åˆ¶**ï¼ˆåç«¯ï¼‰ï¼š

  * `POST /api/tasks/start`ï¼š1 req / 10s
  * `POST /api/upload/batch`ï¼š1 req / 2s
* **å¤§å°é™åˆ¶**ï¼š

  * `POST /api/upload/batch`ï¼š`chunkIds` â‰¤ 100
* **æ—¥å¿—è„±æ•**ï¼šç¦æ­¢æ‰“å° `DRIVEQUIZ_API_TOKEN`ï¼›
* **è·¨åŸŸ**ï¼šGUI ä¸ API åŒæºéƒ¨ç½²ï¼Œé»˜è®¤ä¸å¯ CORSã€‚

---

## 13. éªŒæ”¶ Checklistï¼ˆè¦ç‚¹ï¼‰

* [ ] Source CRUD æŒ‰æ ¡éªŒè§„åˆ™å·¥ä½œï¼Œsources.json æ­£ç¡®è½ç›˜
* [ ] Start/Stop ä»»åŠ¡ç¨³å®šï¼Œ`/ws` èƒ½å®æ—¶æ›´æ–° `task.status` ä¸ `log.append`
* [ ] `GET /api/chunks` æ”¯æŒåˆ†é¡µä¸ç­›é€‰
* [ ] `POST /api/upload/batch` èƒ½è¿”å› DriveQuiz `operationId` ä¸”é€æ¡ç»“æœåŒ¹é…
* [ ] System çŠ¶æ€æ•°å€¼ä¸æœåŠ¡å™¨çœŸå®æƒ…å†µç›¸ç¬¦ï¼ˆå…è®¸ Â±10% æµ®åŠ¨ï¼‰
* [ ] é”™è¯¯ç ä¸æç¤ºä¿¡æ¯ä¸æœ¬è§„èŒƒä¸€è‡´

---

## 14. é™„ï¼šåç«¯å¯¹æ¥ DriveQuiz çš„è½¬å‘å¥‘çº¦

* Datapull åç«¯å°† `ChunkDTO[]` æ˜ å°„ä¸º DriveQuiz `BatchUploadRequest.docs`ï¼š

  * `title/url/content/version/lang` â†’ åŸæ ·
  * `meta`ï¼šå¸¦ `sourceId/chunkIndex/totalChunks/contentHash`
* è°ƒç”¨ï¼š`POST {DRIVEQUIZ_API_URL}/docs/batch`
* å°† DriveQuiz è¿”å›çš„ `results[].status` æ˜ å°„åˆ°æœ¬åœ°ï¼š

  * `success|duplicate|failed` â†’ æ›´æ–° `ChunkDTO.status`
  * `failed` â†’ å†™å…¥ `errorMessage`

---

**ä¸€å¥è¯æ€»ç»“**ï¼š

> æœ¬è§„èŒƒç»Ÿä¸€äº† Datapull GUI çš„**æ•°æ®æ¨¡å‹ã€REST/WS æ¥å£ã€ç»„ä»¶å¥‘çº¦ä¸é”™è¯¯ç **ï¼Œç¡®ä¿â€œé…ç½®â€”æŠ“å–â€”åˆ†ç‰‡â€”ä¸Šä¼ â€”ç›‘æ§â€çš„å…¨é“¾è·¯åœ¨å›¢é˜Ÿé—´**å¯æ›¿æ¢ã€å¯è”è°ƒã€å¯éªŒæ”¶**ã€‚
> è‹¥éœ€è¦ï¼Œæˆ‘å¯ä»¥ç»§ç»­è¾“å‡º **`.env.example`** ä¸ **æ¥å£ Mock æ•°æ®**ï¼Œæ–¹ä¾¿ Cursor ç›´æ¥è¿é€šå¼€å‘ã€‚
