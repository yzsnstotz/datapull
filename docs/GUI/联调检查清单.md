# Datapull 与 DriveQuiz 联调检查清单

## ✅ 已完成的集成点

### 1. DriveQuiz API 客户端
- ✅ `DriveQuizClient` 类已实现
- ✅ 支持批量上传 (`uploadBatch`)
- ✅ 支持单个上传 (`uploadSingle`)
- ✅ 错误处理和重试机制
- ✅ Bearer Token 认证

### 2. 上传服务集成
- ✅ `IngestService` 调用 `processChunks`
- ✅ `processChunks` 调用 `DriveQuizClient.uploadBatch`
- ✅ 操作记录日志

### 3. GUI API 路由
- ✅ `/api/chunks` - 获取分片列表
- ✅ `/api/upload/batch` - 批量上传
- ✅ 错误处理

## ⚠️ 需要修复的问题

### 1. 分片存储问题（关键）
**问题**：爬取服务完成分片后直接上传，但没有将分片存储到 `chunksStore` 中，导致 GUI 无法查看和管理分片。

**影响**：
- GUI 无法查看待上传的分片
- 无法通过 GUI 手动上传分片
- 无法查看分片状态

**解决方案**：
- 在 `CrawlService.startCrawl` 中，分片完成后需要调用 `addChunk` 存储到 `chunksStore`
- 或者修改上传逻辑，先存储分片，再上传

### 2. 上传结果映射问题（重要）
**问题**：在 `src/api/routes/upload.ts` 第177-185行，代码简化处理，假设所有分片都成功，但实际上应该根据 DriveQuiz 返回的结果来更新状态。

**影响**：
- 无法正确反映上传失败的分片
- 无法处理重复文档的情况
- GUI 显示的状态不准确

**解决方案**：
- 根据 `IngestResult.results` 来更新每个分片的状态
- 处理 `success`、`failed`、`duplicate` 三种状态

### 3. DriveQuiz API 格式匹配（需要验证）
**问题**：需要确认 DriveQuiz 客户端发送的数据格式是否与 DriveQuiz API 规范完全匹配。

**需要检查的字段**：
- `title` 字段：DriveQuiz API 需要 `title`，但 `DocumentChunk` 中没有 `title`
- `meta` 字段格式是否正确
- `version` 字段位置是否正确

**解决方案**：
- 检查 `DriveQuizClient.uploadBatch` 中的数据格式
- 确保与 DriveQuiz API 规范一致

### 4. 分片创建时机（需要优化）
**问题**：分片应该在爬取完成后立即存储，而不是在上传时。

**解决方案**：
- 在 `CrawlService.startCrawl` 中，分片完成后立即调用 `addChunk` 存储
- 上传时从 `chunksStore` 读取分片

### 5. 环境变量配置（需要确认）
**问题**：需要确保环境变量正确配置。

**需要检查的变量**：
- `DRIVEQUIZ_API_URL`
- `DRIVEQUIZ_API_TOKEN`

**解决方案**：
- 检查 `.env` 文件
- 确保 API URL 和 Token 正确

## 📋 联调前检查清单

### 后端服务
- [ ] 环境变量 `DRIVEQUIZ_API_URL` 已配置
- [ ] 环境变量 `DRIVEQUIZ_API_TOKEN` 已配置
- [ ] 修复分片存储问题
- [ ] 修复上传结果映射问题
- [ ] 验证 DriveQuiz API 格式匹配
- [ ] 测试批量上传功能
- [ ] 测试错误处理

### GUI
- [ ] 可以查看分片列表
- [ ] 可以选择分片进行上传
- [ ] 可以查看上传结果
- [ ] 可以查看失败的分片和错误信息
- [ ] WebSocket 实时更新

### 集成测试
- [ ] 测试完整流程：爬取 → 分片 → 存储 → 上传
- [ ] 测试批量上传（100个分片）
- [ ] 测试部分成功的情况
- [ ] 测试重复文档的处理
- [ ] 测试错误处理和重试

## 🔧 修复优先级

1. **P0（必须修复）**：
   - 分片存储问题
   - 上传结果映射问题

2. **P1（重要）**：
   - DriveQuiz API 格式匹配验证
   - 环境变量配置检查

3. **P2（优化）**：
   - 分片创建时机优化
   - 错误处理完善

## 📝 下一步行动

1. 修复分片存储问题
2. 修复上传结果映射问题
3. 验证 DriveQuiz API 格式匹配
4. 进行端到端测试
5. 准备联调环境

