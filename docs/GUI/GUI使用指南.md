# Datapull GUI 使用指南

## 📍 访问地址

**GUI 开发服务器**：`http://localhost:5173`

在浏览器中打开上述地址即可使用 GUI 界面。

---

## 🎯 功能模块概览

GUI 提供 5 个主要功能模块：

1. **数据源管理** (`/sources`) - 管理爬取目标网站配置
2. **任务控制** (`/tasks`) - 启动、停止爬取任务，查看任务状态
3. **上传中心** (`/upload`) - 查看分片列表，批量上传到 DriveQuiz
4. **日志查看** (`/logs`) - 实时查看系统、爬取、上传日志
5. **系统状态** (`/system`) - 监控系统资源使用情况

---

## 1️⃣ 数据源管理 (Sources)

### 功能说明
管理要爬取的目标网站配置，包括 URL 规则、语言、版本等信息。

### 操作步骤

#### 1.1 创建数据源

1. 点击页面右上角的 **"新建数据源"** 按钮
2. 填写以下信息：
   - **ID**：唯一标识符（3-50 个字符，只能包含小写字母、数字、下划线）
     - 示例：`gov_npa_driving`、`jaf_official`
   - **名称**：显示名称
     - 示例：`日本警察厅驾驶规则`、`JAF 官方文档`
   - **种子URL**：起始爬取地址（每行一个）
     - 示例：
       ```
       https://www.npa.go.jp/bureau/traffic/
       https://www.npa.go.jp/bureau/traffic/rule/
       ```
   - **包含规则**：URL 匹配规则（可选）
     - 支持 glob 模式：`**/*.pdf`、`**/rule/**`
     - 支持正则表达式：`/rule\/\d+/`
   - **排除规则**：排除的 URL 规则（可选）
     - 示例：`**/archive/**`、`**/*.jpg`
   - **语言**：选择 `ja`（日语）、`zh`（中文）或 `en`（英语）
   - **版本**：数据版本号
     - 格式：`2025Q1` 或 `2025`
   - **爬取深度**：1-5（默认 2）
   - **速率限制**：每秒请求数，1-50（默认 5）
   - **是否启用**：勾选后才会纳入爬取任务
   - **备注**：可选说明

3. 点击 **"保存"** 按钮

#### 1.2 编辑数据源

1. 在数据源列表中点击要编辑的数据源
2. 修改需要更新的字段（ID 不可修改）
3. 点击 **"保存"** 按钮

#### 1.3 删除数据源

1. 在数据源列表中点击要删除的数据源
2. 点击 **"删除"** 按钮
3. 确认删除操作

#### 1.4 搜索数据源

在页面顶部的搜索框中输入关键词，可以按 ID 或名称进行模糊搜索。

---

## 2️⃣ 任务控制 (Tasks)

### 功能说明
启动、停止爬取任务，实时查看任务状态和进度。

### 操作步骤

#### 2.1 启动任务

1. 进入 **"任务控制"** 页面
2. 点击 **"启动任务"** 按钮
3. 选择启动模式：
   - **全量爬取**：爬取所有启用的数据源
   - **增量爬取**：只爬取新增或更新的内容
4. 选择数据源（可选）：
   - 如果留空，将爬取所有 `enabled=true` 的数据源
   - 可以指定特定的数据源 ID 列表

#### 2.2 查看任务状态

任务状态显示：
- **状态**：`idle`（空闲）、`running`（运行中）、`stopped`（已停止）、`error`（错误）
- **开始时间**：任务启动时间
- **运行中的源**：当前正在爬取的数据源列表
- **进度**：按数据源显示：
  - 已访问页面数
  - 已生成分片数
  - 已上传数
  - 失败数

#### 2.3 停止任务

1. 在任务运行期间，点击 **"停止任务"** 按钮
2. 任务将安全停止，已处理的数据不会丢失

---

## 3️⃣ 上传中心 (Upload)

### 功能说明
查看已生成的分片列表，选择分片批量上传到 DriveQuiz。

### 操作步骤

#### 3.1 查看分片列表

1. 进入 **"上传中心"** 页面
2. 使用筛选器：
   - **状态筛选**：`pending`（待上传）、`uploaded`（已上传）、`failed`（失败）
   - **数据源筛选**：选择特定数据源或查看全部

#### 3.2 选择分片

1. 在分片列表中勾选要上传的分片
2. 可以多选，支持分页选择

#### 3.3 批量上传

1. 选择要上传的分片后，点击 **"上传选中"** 按钮
2. 系统将批量上传到 DriveQuiz API
3. 上传过程中会显示进度和结果：
   - **成功**：分片已成功上传
   - **失败**：显示错误信息
   - **重复**：文档已存在，跳过

#### 3.4 查看上传结果

上传完成后，可以：
- 查看每个分片的上传状态
- 查看失败原因（如有）
- 查看操作 ID（`operationId`），可用于在 DriveQuiz API 中查询详情

---

## 4️⃣ 日志查看 (Logs)

### 功能说明
实时查看系统运行日志，包括系统日志、爬取日志、上传日志。

### 操作步骤

#### 4.1 筛选日志

1. 进入 **"日志查看"** 页面
2. 使用筛选器：
   - **类型**：`system`（系统）、`crawl`（爬取）、`upload`（上传）
   - **数据源**：选择特定数据源
   - **级别**：`info`（信息）、`warn`（警告）、`error`（错误）
   - **数量限制**：最多显示 1000 条

#### 4.2 实时日志

- 日志通过 WebSocket 实时推送
- 新日志会自动追加到列表顶部
- 支持自动滚动查看最新日志

#### 4.3 日志格式

每条日志包含：
- **时间戳**：日志产生时间
- **类型**：日志类型
- **级别**：日志级别
- **消息**：日志内容
- **数据源**：关联的数据源 ID（如有）

---

## 5️⃣ 系统状态 (System)

### 功能说明
监控系统资源使用情况和运行状态。

### 显示信息

- **版本**：Datapull 版本号
- **运行时间**：服务运行时长（秒）
- **CPU 使用率**：当前 CPU 使用百分比
- **内存使用率**：当前内存使用百分比
- **磁盘可用空间**：可用磁盘空间（GB）
- **队列大小**：待处理/待上传队列长度
- **DriveQuiz 连通性**：是否能够连接到 DriveQuiz API

---

## 🔄 完整工作流程

### 典型使用流程

1. **配置数据源**
   - 进入 **"数据源管理"** 页面
   - 创建或编辑数据源配置
   - 确保数据源已启用（`enabled=true`）

2. **启动爬取任务**
   - 进入 **"任务控制"** 页面
   - 点击 **"启动任务"** 按钮
   - 选择要爬取的数据源
   - 监控任务进度

3. **查看爬取结果**
   - 在 **"任务控制"** 页面查看进度
   - 在 **"日志查看"** 页面查看详细日志

4. **上传分片**
   - 进入 **"上传中心"** 页面
   - 筛选待上传的分片（`status=pending`）
   - 选择要上传的分片
   - 点击 **"上传选中"** 按钮
   - 等待上传完成

5. **验证上传结果**
   - 在 **"上传中心"** 页面查看上传状态
   - 在 **"日志查看"** 页面查看上传日志
   - 使用 `operationId` 在 DriveQuiz API 中查询详情

---

## ⚠️ 注意事项

### 1. 数据源配置

- **ID 格式**：必须符合 `^[a-z0-9_]{3,50}$` 规则
- **种子URL**：必须是有效的 HTTP(S) URL
- **版本格式**：`2025Q1` 或 `2025`
- **语言代码**：只能是 `ja`、`zh`、`en` 之一

### 2. 任务管理

- 同一时间只能运行一个爬取任务
- 停止任务后，已处理的数据不会丢失
- 任务运行期间可以查看实时进度

### 3. 上传操作

- 批量上传建议每批不超过 50 个分片
- 上传失败的分片可以重新上传
- 重复文档会自动跳过，不会报错

### 4. 系统要求

- 确保 DriveQuiz API 服务正常运行（`http://localhost:8789`）
- 确保 API 服务器正常运行（`http://localhost:3100`）
- 确保网络连接正常

---

## 🐛 常见问题

### Q1: 无法启动任务？

**可能原因**：
- 没有启用的数据源
- 任务已在运行中
- DriveQuiz API 不可达

**解决方法**：
- 检查数据源是否已启用
- 查看系统状态中的 DriveQuiz 连通性
- 查看日志中的错误信息

### Q2: 上传失败？

**可能原因**：
- DriveQuiz API 不可达
- Token 配置错误
- 网络连接问题

**解决方法**：
- 检查 `.env` 文件中的 `DRIVEQUIZ_API_TOKEN` 配置
- 检查 DriveQuiz API 服务是否运行
- 查看日志中的详细错误信息

### Q3: 分片列表为空？

**可能原因**：
- 还没有运行过爬取任务
- 所有分片都已上传
- 筛选条件不正确

**解决方法**：
- 先运行爬取任务生成分片
- 检查筛选器设置
- 查看任务进度确认是否已生成分片

---

## 📞 技术支持

如有问题，请：
1. 查看 **"日志查看"** 页面中的错误日志
2. 查看 **"系统状态"** 页面中的系统信息
3. 检查后端 API 服务日志（`logs/runtime.log`）

---

**最后更新**：2025-01-07

