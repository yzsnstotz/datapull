# ğŸ§ªã€ŠDatapull æµ‹è¯•æ–‡æ¡£ v1.0ã€‹â€” äº¤ä»˜ç»™ Cursor çš„â€œä¸€æ­¥åˆ°ä½â€æµ‹è¯•æ–¹æ¡ˆ

> ç›®æ ‡ï¼šåœ¨æœ¬åœ°ä¸€æ¬¡è·‘é€š **å•å…ƒ + é›†æˆ + ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰+ æ€§èƒ½ + å¼‚å¸¸** å…¨é‡æµ‹è¯•ï¼Œè¦†ç›–ç‡â‰¥80%ï¼Œæ‰¹é‡ä¸Šä¼  100 æ–‡æ¡£ç”¨æ—¶ <5sï¼ŒAPI æˆåŠŸç‡â‰¥99.5%ã€‚ã€turn1file3â€ L1-L6ã€‘ã€turn1file3â€ L8-L13ã€‘

---

## 0. æµ‹è¯•èŒƒå›´ä¸é€šè¿‡æ ‡å‡†ï¼ˆä¸è§„èŒƒå¯¹é½ï¼‰

* è¦†ç›–æ¨¡å—ï¼šTypes / Crawler / Extractor / Chunker / Ingester / Service / Utils / CLIã€‚
* é€šè¿‡æ ‡å‡†ï¼š

  * **åŠŸèƒ½å®Œå¤‡**ï¼šæŒ‰æ ¸å¯¹æ¸…å•åˆ—å‡ºçš„æ‰€æœ‰æ¨¡å—ã€è„šæœ¬å‡å¯æ‰§è¡Œä¸”é€šè¿‡æµ‹è¯•ã€‚ã€turn1file4â€ L31-L41ã€‘ã€turn1file5â€ L21-L27ã€‘
  * **æ—¥å¿—å¯è§‚æµ‹**ï¼šæ—¥å¿—äº‹ä»¶åŒ…å« `crawl.* / extract.* / chunk.* / ingest.*` ç­‰å¹¶ç»“æ„åŒ–è¾“å‡ºã€‚ã€turn1file1â€ L3-L12ã€‘ã€turn1file1â€ L16-L25ã€‘
  * **æ¥å£å¯¹é½**ï¼šä¸ DriveQuiz API çš„å¥åº·æ£€æŸ¥ã€å•æ–‡æ¡£ã€æ‰¹é‡ä¸Šä¼ ã€æ“ä½œæŸ¥è¯¢ä¸€è‡´ï¼›ä½¿ç”¨ Bearer tokenã€‚ã€turn1file12â€ L1-L7ã€‘ã€turn1file12â€ L9-L13ã€‘
  * **æ€§èƒ½è¾¾æ ‡**ï¼š100 æ–‡æ¡£ < 5sï¼›å•æ–‡æ¡£ < 300msï¼›æˆåŠŸç‡â‰¥99.5%ï¼Œé”™è¯¯ç‡â‰¤3%ã€‚ã€turn1file7â€ L31-L37ã€‘
  * **è¦†ç›–ç‡**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%ã€‚ã€turn1file3â€ L1-L4ã€‘

---

## 1. å‰ç½®æ¡ä»¶ï¼ˆCursor ä¸€æ¬¡æ€§å®Œæˆï¼‰

### 1.1 ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env`ï¼ˆå‚è€ƒ `.env.example`ï¼‰ï¼š

```bash
DRIVEQUIZ_API_URL=https://<your-drivequiz-host>/api/v1/rag
DRIVEQUIZ_API_TOKEN=<service-token>
CRAWL_CONCURRENCY=5
LOG_LEVEL=info
CACHE_DIR=./data/cache
```

> `.env.example` å·²æä¾›ï¼Œéœ€è¡¥å……çœŸå®å˜é‡ï¼›è¯¥é¡¹åœ¨æ ¸å¯¹æ¸…å•ä¸­ä¸ºâ€œå¾…ç”¨æˆ·é…ç½®â€ã€‚ã€turn1file0â€ L1-L7ã€‘ã€turn1file5â€ L34-L37ã€‘

### 1.2 ä¾èµ–å®‰è£…ä¸å¿«é€Ÿä½“æ£€

```bash
pnpm i
pnpm build
pnpm validate          # æ ¡éªŒ config/sources.json ç»“æ„
pnpm --filter datapull test -- --version || true
```

### 1.3 DriveQuiz API å¯ç”¨æ€§æ ¡éªŒ

```bash
curl -s -H "Authorization: Bearer $DRIVEQUIZ_API_TOKEN" \
  "$DRIVEQUIZ_API_URL/health"
# æœŸæœ› 200/ok
```

> å¯¹é½å¯¹æ¥æ¸…å•çš„å¥åº·æ£€æŸ¥ä¸è®¤è¯æ–¹å¼ã€‚ã€turn1file12â€ L1-L7ã€‘ã€turn1file12â€ L9-L13ã€‘

---

## 2. æµ‹è¯•æ•°æ®ä¸ç›®å½•

### 2.1 sources.jsonï¼ˆæœ€ä½å¯ç”¨æ ·ä¾‹ï¼‰

`config/sources.json`

```json
[
  {
    "sourceId": "gov_npa_driving",
    "seedUrls": ["https://www.npa.go.jp/bureau/traffic/license/"],
    "include": ["license","faq"],
    "exclude": ["#"],
    "lang": "ja",
    "version": "2025Q1"
  }
]
```

> æ¥è‡ªäº§å“/ç ”å‘æ–‡æ¡£çš„å»ºè®®ç»“æ„ä¸å­—æ®µå‘½åï¼Œæ»¡è¶³å¤šè¯­è¨€ä¸ç‰ˆæœ¬æ ‡è¯†è¦æ±‚ã€‚ã€turn1file6â€ L31-L35ã€‘ã€turn1file1â€ L56-L65ã€‘

### 2.2 æœ¬åœ°å¤¹å¸¦çš„æµ‹è¯•å¤¹å…·ï¼ˆfixturesï¼‰

```
tests/fixtures/
 â”œâ”€â”€ sample-ja.html      # å«è„šæ³¨ã€å¯¼èˆªã€è„šéƒ¨ã€å¹¿å‘Šç­‰å™ªéŸ³
 â”œâ”€â”€ sample-zh.html
 â”œâ”€â”€ sample-en.html
 â”œâ”€â”€ sample.pdf          # å¤šé¡µ PDFï¼ŒåµŒå…¥å¸¸è§å™ªå£°
 â””â”€â”€ tiny.txt            # <100 å­—ç¬¦ï¼ˆè§¦å‘ CONTENT_TOO_SHORTï¼‰
```

> è¿™äº›æ ·ä¾‹ç”¨äºéªŒè¯æå–ã€æ¸…æ´—ã€åˆ†ç‰‡è¾¹ç•Œã€å¼‚å¸¸ç ä¸ PDF æ”¯æŒï¼ˆè§„èŒƒè¦æ±‚ï¼‰ã€‚ã€turn1file2â€ L61-L68ã€‘ã€turn1file2â€ L71-L82ã€‘

---

## 3. å•å…ƒæµ‹è¯•ï¼ˆVitestï¼‰

> ç›®æ ‡ï¼šå‡½æ•°çº§æ­£ç¡®æ€§ã€ç±»å‹ä¸€è‡´æ€§ã€é”™è¯¯ç ä¸æ—¥å¿—äº‹ä»¶ç¬¦åˆè§„èŒƒä¸å‚æ•°è¡¨ã€‚ã€turn1file1â€ L29-L40ã€‘ã€turn1file1â€ L43-L53ã€‘

### 3.1 å‘½ä»¤

```bash
pnpm test              # å•å…ƒæµ‹è¯•
pnpm test:coverage     # è¾“å‡ºè¦†ç›–ç‡
```

### 3.2 å»ºè®®ç”¨ä¾‹è¡¨ï¼ˆç¤ºä¾‹ï¼‰

* `crawler/fetcher.spec.ts`

  * å…è®¸æŠ“å– HTMLã€è¯†åˆ« PDFã€robots æ ¡éªŒã€3 æ¬¡æŒ‡æ•°é€€é¿é‡è¯•ã€é™æµâ‰¥500msã€‚ã€turn1file2â€ L49-L53ã€‘
* `extractors/html-extractor.spec.ts`

  * è¿‡æ»¤ `<script>/<nav>/<footer>`ã€å»é‡ç©ºè¡Œã€ä¿ç•™æ ‡é¢˜ä¸ URLã€ç¼–ç è¯†åˆ«ï¼ˆUTF-8/Shift_JISï¼‰ã€‚ã€turn1file2â€ L63-L68ã€‘
* `extractors/pdf-extractor.spec.ts`

  * å¤šé¡µ PDF æ–‡æœ¬æå–ä¸é¡µå†…å™ªå£°æ¸…ç†ã€‚
* `chunkers/text-chunker.spec.ts`

  * 500â€“800 å­—ç¬¦åˆ†ç‰‡ã€â‰¥100 å­—ç¬¦æ ¡éªŒã€å¥å·/æ¢è¡Œä¼˜å…ˆæ–­ç‚¹ã€è·¨è¯­è¨€ç­–ç•¥ã€‚ã€turn1file2â€ L75-L82ã€‘
* `ingesters/drivequiz-client.spec.ts`

  * å•/æ‰¹é‡ä¸Šä¼ å‚æ•°æ˜ å°„ã€409 é‡å¤å†…å®¹è·³è¿‡ã€401/429 é”™è¯¯ç é€ä¼ ã€‚ã€turn1file1â€ L29-L39ã€‘
* `utils/logger.spec.ts`

  * äº‹ä»¶æ ¼å¼åº”åŒ…å« `event, sourceId, operationId, processed` ç­‰å­—æ®µï¼ˆè§æ—¥å¿—ç¤ºä¾‹ï¼‰ã€‚ã€turn1file1â€ L16-L25ã€‘

**é€šè¿‡é—¨æ§›**ï¼šè¦†ç›–ç‡â‰¥80%ã€‚ã€turn1file3â€ L1-L4ã€‘

---

## 4. é›†æˆæµ‹è¯•ï¼ˆSupertest / çœŸå® API æ²™ç®±ï¼‰

> ç›®æ ‡ï¼šæŒ‰çœŸå®é…ç½®ä»æŠ“å–â†’æå–â†’åˆ†ç‰‡â†’ä¸Šä¼ å…¨é“¾è·¯æ‰“é€šï¼Œä¿è¯äº‹ä»¶æ—¥å¿—ä¸è¿”å›ç ä¸€è‡´ã€‚
> å‚è€ƒâ€œä¸‰ä½ä¸€ä½“æ¸…å•Â·æµ‹è¯•é¡¹æ¸…å•â€ä¸­çš„åŠŸèƒ½ã€å¼‚å¸¸ã€å‹åŠ›åœºæ™¯ã€‚ã€turn1file7â€ L3-L14ã€‘ã€turn1file7â€ L17-L25ã€‘

### 4.1 å‘½ä»¤

```bash
pnpm test:integration
```

### 4.2 åœºæ™¯æ¸…å•ï¼ˆæœ€å°è¦†ç›–ï¼‰

1. **HTML æŠ“å–**ï¼š`https://www.npa.go.jp` â†’ 200 ä¸”æœ‰ htmlã€‚ã€turn1file7â€ L7-L11ã€‘
2. **PDF æŠ“å–**ï¼šæä¾› PDF é“¾æ¥ â†’ å¾—åˆ° buffer/æ–‡æœ¬ä½“ã€‚ã€turn1file7â€ L9-L11ã€‘
3. **æå–æ¸…ç†**ï¼šå«è„šæ³¨/å¯¼èˆª/è„šéƒ¨ â†’ è¾“å‡ºçº¯æ–‡æœ¬æ— å¹¿å‘Šã€‚ã€turn1file7â€ L11-L13ã€‘
4. **åˆ†ç‰‡è¾¹ç•Œ**ï¼štiny æ–‡æœ¬ â†’ æŠ› `CONTENT_TOO_SHORT`ã€‚ã€turn1file7â€ L11-L13ã€‘
5. **æ‰¹é‡ä¸Šä¼ **ï¼š10 ä»½æœ‰æ•ˆæ–‡æ¡£ â†’ `processed=10, failed=0`ã€‚ã€turn1file7â€ L11-L14ã€‘
6. **401 æ—  Token**ï¼šç§»é™¤ Authorization â†’ è¿”å› 401ã€‚ã€turn1file7â€ L21-L23ã€‘
7. **409 é‡å¤**ï¼šç›¸åŒ `contentHash` äºŒæ¬¡ä¸Šä¼  â†’ è¿”å› 409ã€‚ã€turn1file7â€ L21-L23ã€‘
8. **429 é™æµ**ï¼šå¿«é€Ÿè¿ç»­ 100 æ¬¡ â†’ è¿”å› 429ã€‚ã€turn1file7â€ L21-L24ã€‘

**æ—¥å¿—éªŒæ”¶**ï¼šäº‹ä»¶ `ingest.success` åº”å«ç»“æ„åŒ–å­—æ®µï¼ˆç¤ºä¾‹è§å‚æ•°è§„èŒƒï¼‰ã€‚ã€turn1file1â€ L16-L25ã€‘

---

## 5. ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰ä¸æ€§èƒ½æµ‹è¯•

### 5.1 E2Eï¼ˆå¸¦ dry-run ä¸çœŸå®å…¥åº“ä¸¤å¥—ï¼‰

```bash
# Dry-runï¼šä¸å…¥åº“ï¼Œä»…éªŒè¯æŠ“å–/æå–/åˆ†ç‰‡/æ—¥å¿—
pnpm crawl --dry-run

# çœŸå®å…¥åº“ï¼ˆè¯·åœ¨éç”Ÿäº§åº“è·‘ï¼‰
pnpm crawl
```

**éªŒæ”¶**ï¼šç”Ÿæˆ `operationId`ï¼ŒDriveQuiz åç«¯è§¦å‘å‘é‡åŒ–ï¼ˆdatapull æ— éœ€ä¸»åŠ¨å‘é‡åŒ–ï¼‰ã€‚ã€turn1file6â€ L49-L57ã€‘ã€turn1file11â€ L107-L114ã€‘

### 5.2 æ€§èƒ½å‹æµ‹ï¼ˆ100 æ–‡æ¡£ï¼‰

```bash
# é¢„å¤‡ï¼šå‡†å¤‡ 100 ç¯‡ä¸­ç­‰é•¿åº¦ï¼ˆæ—¥è¯­ï¼‰æ–‡æœ¬ï¼Œæˆ–æŠ“å–åç¼“å­˜å†å…¥åº“
pnpm report               # ç»Ÿè®¡æœ¬æ¬¡æ“ä½œ processed/failed/è€—æ—¶
```

**é—¨æ§›**ï¼š100 æ–‡æ¡£å¤„ç† <5sï¼ˆæ‰¹é‡ä¸Šä¼ ï¼‰ï¼Œå•æ–‡æ¡£ <300msï¼›æˆåŠŸç‡â‰¥99.5%ï¼Œé”™è¯¯ç‡â‰¤3%ã€‚ã€turn1file3â€ L1-L6ã€‘ã€turn1file7â€ L31-L37ã€‘

---

## 6. ç»“æœäº§ç‰©ä¸å®¡æŸ¥

### 6.1 äº§å‡ºç›®å½•

```
logs/
 â”œâ”€ operations/op_<timestamp>.json  # operationId + æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
 â””â”€ error.log                        # å¤±è´¥é¡¹/é‡è¯•ä¿¡æ¯
reports/
 â””â”€ perf-<date>.md                   # 100 æ–‡æ¡£æ€§èƒ½æŠ¥å‘Šï¼ˆå«åŸå§‹ç»Ÿè®¡ï¼‰
coverage/
 â””â”€ lcov-report/index.html           # è¦†ç›–ç‡æŠ¥å‘Š
```

### 6.2 PR éªŒæ”¶å‹¾é€‰

* [ ] `pnpm validate` é€šè¿‡ï¼ˆsources schema æ­£ç¡®ï¼‰ã€‚
* [ ] `pnpm test` è¦†ç›–ç‡â‰¥80%ã€‚ã€turn1file3â€ L1-L4ã€‘
* [ ] `pnpm test:integration` å…¨ç»¿ï¼Œå« 401/409/429 ç­‰å¼‚å¸¸æ–­è¨€ã€‚
* [ ] `pnpm crawl --dry-run` å…¨é“¾è·¯æˆåŠŸï¼Œæ—¥å¿—äº‹ä»¶å®Œæ•´ã€‚
* [ ] `pnpm crawl` çœŸå®å…¥åº“æˆåŠŸï¼ŒDriveQuiz å¯è§ `operationId`ã€‚ã€turn1file11â€ L109-L114ã€‘
* [ ] `pnpm report` æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ï¼ˆ100 æ–‡æ¡£ <5sï¼‰ã€‚ã€turn1file3â€ L1-L6ã€‘

---

## 7. å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

* **Qï¼šæ—¥å¿—å­—æ®µç¼ºé¡¹æˆ–æ ¼å¼ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ**
  Aï¼šå¯¹ç…§â€œæ—¥å¿—ä¸çŠ¶æ€äº‹ä»¶è§„èŒƒâ€çš„å­—æ®µè¡¨ä¸ç¤ºä¾‹ä¿®æ­£è¾“å‡ºã€‚ã€turn1file1â€ L3-L12ã€‘ã€turn1file1â€ L16-L25ã€‘

* **Qï¼šè¿”å› 409ï¼ˆé‡å¤æ–‡æ¡£ï¼‰æ˜¯å¦ç®—å¤±è´¥ï¼Ÿ**
  Aï¼šä¸ç®—é˜»æ–­æ€§å¤±è´¥ï¼›åº”è·³è¿‡å¹¶è®°å½•ï¼ˆIngester è´Ÿè´£é‡è¯•ä¸è·³è¿‡ç­–ç•¥ï¼‰ã€‚ã€turn1file11â€ L76-L86ã€‘ã€turn1file11â€ L89-L99ã€‘

* **Qï¼šAPI è·¯å¾„ä¸è®¤è¯**
  Aï¼šç»Ÿä¸€èµ° `/api/v1/rag/*`ï¼Œä½¿ç”¨ `Authorization: Bearer <TOKEN>`ã€‚ã€turn1file12â€ L1-L7ã€‘ã€turn1file12â€ L9-L13ã€‘

---

## 8. Cursor æ‰§è¡Œæ¸…å•ï¼ˆå¯ç›´æ¥è´´ç»™ Cursorï¼‰

```bash
# 1) å®‰è£…ä¸æ„å»º
pnpm i && pnpm build

# 2) ç¯å¢ƒæ ¡éªŒ
pnpm validate

# 3) å•å…ƒæµ‹è¯• + è¦†ç›–ç‡
pnpm test && pnpm test:coverage

# 4) é›†æˆæµ‹è¯•ï¼ˆå«å¼‚å¸¸ç ï¼‰
pnpm test:integration

# 5) E2Eï¼ˆdry-runï¼‰
pnpm crawl --dry-run

# 6) E2Eï¼ˆçœŸå®å…¥åº“ï¼Œéç”Ÿäº§ï¼‰
pnpm crawl

# 7) æ€§èƒ½æŠ¥å‘Šï¼ˆ100 æ–‡æ¡£ï¼‰
pnpm report

# 8) äº§å‡ºæ”¶é›†ï¼ˆlogs / reports / coverageï¼‰
ls -la logs/ reports/ coverage/
```

---

## 9. å…³è”æ–‡æ¡£ï¼ˆæµ‹è¯•å¯¹é½ä¾æ®ï¼‰

---

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘ä¹Ÿå¯ä»¥æŠŠä¸Šé¢çš„å‘½ä»¤ä¸æ–­è¨€è½¬æ¢æˆ **`/tests` ç›®å½•ä¸‹çš„å®é™…æµ‹è¯•ä»£ç æ¸…å•ï¼ˆVitest + Supertestï¼‰** ä¸ **GitHub Actions CI é…ç½®**ï¼Œç›´æ¥è½åœ°ä¸º `pnpm test`/`pnpm test:integration` çš„å¯æ‰§è¡Œå®ç°ã€‚
